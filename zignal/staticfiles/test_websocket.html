<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        #log {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        .logEntry {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }
        .time {
            color: #6c757d;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <h2>Connection Log</h2>
    <div id="log"></div>
    
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
    
    <h2>Send Test Message</h2>
    <div>
        <textarea id="message" rows="3" style="width: 100%;" placeholder="Enter message to send"></textarea>
    </div>
    <button id="sendBtn" disabled>Send</button>
    
    <script>
        // DOM Elements
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const messageEl = document.getElementById('message');
        const sendBtn = document.getElementById('sendBtn');
        
        // Variables
        let socket = null;
        
        // Functions
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            return `${protocol}//${host}/ws/notifications/`;
        }
        
        function updateStatus(status) {
            statusEl.textContent = status;
            statusEl.className = 'status';
            
            if (status === 'Connected') {
                statusEl.classList.add('connected');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
            } else if (status === 'Disconnected') {
                statusEl.classList.add('disconnected');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
            } else if (status === 'Connecting...') {
                statusEl.classList.add('connecting');
                connectBtn.disabled = true;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
            }
        }
        
        function logMessage(message, isError = false) {
            const now = new Date();
            const time = now.toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'logEntry';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'time';
            timeSpan.textContent = `[${time}] `;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = isError ? 'error' : '';
            messageSpan.textContent = message;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function connect() {
            try {
                updateStatus('Connecting...');
                logMessage('Attempting to connect to WebSocket...');
                
                const url = getWebSocketUrl();
                logMessage(`WebSocket URL: ${url}`);
                
                socket = new WebSocket(url);
                
                socket.onopen = function(e) {
                    updateStatus('Connected');
                    logMessage('WebSocket connection established!');
                };
                
                socket.onmessage = function(e) {
                    try {
                        const data = JSON.parse(e.data);
                        logMessage(`Received message: ${JSON.stringify(data, null, 2)}`);
                    } catch (err) {
                        logMessage(`Received non-JSON message: ${e.data}`);
                    }
                };
                
                socket.onclose = function(e) {
                    updateStatus('Disconnected');
                    if (e.wasClean) {
                        logMessage(`Connection closed cleanly, code=${e.code}, reason=${e.reason}`);
                    } else {
                        logMessage('Connection died', true);
                    }
                };
                
                socket.onerror = function(e) {
                    logMessage('WebSocket error', true);
                    console.error('WebSocket error:', e);
                };
            } catch (error) {
                updateStatus('Disconnected');
                logMessage(`Error creating WebSocket: ${error.message}`, true);
                console.error('WebSocket creation error:', error);
            }
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
                updateStatus('Disconnected');
                logMessage('Disconnected from WebSocket');
            }
        }
        
        function sendMessage() {
            const message = messageEl.value.trim();
            if (!message || !socket) return;
            
            try {
                // Try to parse as JSON first
                let jsonData;
                try {
                    jsonData = JSON.parse(message);
                } catch (e) {
                    // If not valid JSON, use as plain text
                    jsonData = {
                        type: 'message',
                        text: message
                    };
                }
                
                socket.send(JSON.stringify(jsonData));
                logMessage(`Sent message: ${JSON.stringify(jsonData, null, 2)}`);
                messageEl.value = '';
            } catch (error) {
                logMessage(`Error sending message: ${error.message}`, true);
            }
        }
        
        // Event Listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendBtn.addEventListener('click', sendMessage);
        
        // Initialize
        updateStatus('Disconnected');
        logMessage('WebSocket test page loaded. Click "Connect" to start the WebSocket connection.');
    </script>
</body>
</html> 